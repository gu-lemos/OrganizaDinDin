@model List<Gasto>
@{
    ViewData["Title"] = "Resumo de OrganizaDinDin";
    var totalGeral = Model.Sum(g => g.Valor) / 100.0;
    var OrganizaDinDinPorTipo = Model.GroupBy(g => g.Tipo)
                             .Select(g => new {
                                 Tipo = g.Key,
                                 Total = g.Sum(x => x.Valor) / 100.0,
                                 Quantidade = g.Count()
                             })
                             .OrderByDescending(x => x.Total)
                             .ToList();
}

@section Styles {
    <link rel="stylesheet" href="~/css/resumo.css" asp-append-version="true" />
}

<div class="page-title d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <h1>Resumo de Gastos</h1>
</div>

<!-- Cards de Resumo -->
<div class="row summary-cards">
    <div class="col-md-6">
        <div class="card text-white bg-primary summary-card">
            <div class="card-body">
                <h5 class="card-title">Total Gasto</h5>
                <h2 class="card-text">R$ @totalGeral.ToString("N2")</h2>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card text-white bg-success summary-card">
            <div class="card-body">
                <h5 class="card-title">Total de Lançamentos</h5>
                <h2 class="card-text">@Model.Count</h2>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row charts-row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <div class="card chart-card">
            <div class="card-header">
                <h5>Gastos por Tipo</h5>
            </div>
            <div class="card-body">
                <canvas id="chartPorTipo"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card chart-card">
            <div class="card-header">
                <h5>Distribuição Percentual</h5>
            </div>
            <div class="card-body">
                <canvas id="chartPizza"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Resumo por Tipo -->
<div class="row">
    <div class="col-12">
        <div class="card detail-card">
            <div class="card-header">
                <h5>Detalhamento por Tipo</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                                <th>Percentual</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in OrganizaDinDinPorTipo)
                            {
                                var percentual = (item.Total / totalGeral) * 100;
                                <tr>
                                    <td><span class="badge bg-dark type-badge">@item.Tipo.GetDescription()</span></td>
                                    <td>@item.Quantidade</td>
                                    <td class="text-success fw-bold">R$ @item.Total.ToString("N2")</td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress custom-progress flex-grow-1">
                                                <div class="progress-bar bg-success custom-progress-bar" role="progressbar" style="width: @percentual.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)%" aria-valuenow="@percentual" aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                            <span class="percentage-label">@percentual.ToString("N1")%</span>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.gastosPorTipo = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            OrganizaDinDinPorTipo.Select(g => new {
                Tipo = g.Tipo.GetDescription(),
                Total = g.Total
            })
        ));
    </script>
    <script src="~/js/resumo.js" asp-append-version="true"></script>
}
