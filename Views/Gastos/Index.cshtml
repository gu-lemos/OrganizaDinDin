@model List<Gasto>
@{
    ViewData["Title"] = "Gerenciamento de Gastos";
}

<div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><i class="bi bi-wallet"></i> Gerenciamento de Gastos</h1>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#gastoModal" onclick="abrirModalCriar()">
            + Novo Gasto
        </button>
    </div>

    <!-- Navega√ß√£o por Abas -->
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="/Gastos/Index">Listagem</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/Gastos/Resumo">Resumo</a>
        </li>
    </ul>
</div>

<div class="table-responsive">
    <table class="table table-hover table-striped">
        <thead>
            <tr>
                <th>Descri√ß√£o</th>
                <th>Tipo</th>
                <th>Data</th>
                <th>Valor</th>
                <th class="text-center">A√ß√µes</th>
            </tr>
        </thead>
        <tbody id="OrganizaDinDinTableBody">
            @foreach (var gasto in Model)
            {
                <tr data-id="@gasto.Id">
                    <td>@gasto.Descricao</td>
                    <td><span class="badge badge-tipo bg-info">@gasto.Tipo.GetDescription()</span></td>
                    <td>@gasto.Data.ToString("dd/MM/yyyy")</td>
                    <td class="valor-positivo">R$ @((gasto.Valor / 100.0).ToString("N2"))</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning" onclick="editarGasto('@gasto.Id')" title="Editar">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deletarGasto('@gasto.Id')" title="Excluir">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            }
        </tbody>
        @if (Model.Any())
        {
            <tfoot>
                <tr class="table-secondary">
                    <td colspan="3" class="text-end fw-bold">TOTAL:</td>
                    <td class="fw-bold text-success">R$ @((Model.Sum(g => g.Valor) / 100.0).ToString("N2"))</td>
                    <td></td>
                </tr>
            </tfoot>
        }
    </table>
</div>

<!-- Modal para Criar/Editar Gasto -->
<div class="modal fade" id="gastoModal" tabindex="-1" aria-labelledby="gastoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gastoModalLabel">Novo Gasto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="gastoForm">
                    <input type="hidden" id="gastoId" />

                    <div class="mb-3">
                        <label for="descricao" class="form-label">Descri√ß√£o</label>
                        <input type="text" class="form-control" id="descricao" required>
                    </div>

                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo</label>
                        <select class="form-select" id="tipo" required>
                            <option value="0">Entrada</option>
                            <option value="1">Parcela da entrada</option>
                            <option value="2">Evolu√ß√£o de obra</option>
                            <option value="3">Financiamento</option>
                            <option value="4">Reforma</option>
                            <option value="5">Registro, documenta√ß√£o e taxas</option>
                            <option value="6">M√≥veis</option>
                            <option value="7">Eletrodom√©sticos</option>
                            <option value="8">Outros</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="data" class="form-label">Data</label>
                        <input type="date" class="form-control" id="data" required>
                    </div>

                    <div class="mb-3">
                        <label for="valor" class="form-label">Valor</label>
                        <input type="number" step="0.01" class="form-control" id="valor" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarGasto()">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let OrganizaDinDin = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        function abrirModalCriar() {
            document.getElementById('gastoModalLabel').textContent = 'Novo Gasto';
            document.getElementById('gastoForm').reset();
            document.getElementById('gastoId').value = '';
        }

        function editarGasto(id) {
            const gasto = OrganizaDinDin.find(g => g.Id === id);
            if (!gasto) return;

            document.getElementById('gastoModalLabel').textContent = 'Editar Gasto';
            document.getElementById('gastoId').value = gasto.Id;
            document.getElementById('descricao').value = gasto.Descricao;
            document.getElementById('tipo').value = gasto.Tipo;
            document.getElementById('data').value = gasto.Data.split('T')[0];
            document.getElementById('valor').value = (gasto.Valor / 100).toFixed(2); // Converte centavos para reais

            new bootstrap.Modal(document.getElementById('gastoModal')).show();
        }

        async function salvarGasto() {
            const id = document.getElementById('gastoId').value;
            const valorInput = parseFloat(document.getElementById('valor').value);
            const valorCentavos = Math.round(valorInput * 100); // Converte para centavos

            const gasto = {
                Id: id || null,
                Descricao: document.getElementById('descricao').value,
                Tipo: parseInt(document.getElementById('tipo').value),
                Data: document.getElementById('data').value,
                Valor: valorCentavos
            };

            const url = id ? '/Gastos/Update' : '/Gastos/Create';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gasto)
                });

                const result = await response.json();

                if (result.success) {
                    alert(id ? 'Gasto atualizado com sucesso!' : 'Gasto criado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + result.message);
                }
            } catch (error) {
                alert('Erro ao salvar gasto: ' + error);
            }
        }

        async function deletarGasto(id) {
            if (!confirm('Tem certeza que deseja deletar este gasto?')) return;

            try {
                const response = await fetch('/Gastos/Delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(id)
                });

                const data = await response.json();

                if (data.success) {
                    alert('Gasto deletado com sucesso!');
                    location.reload();
                } else {
                    alert('Erro: ' + data.message);
                }
            } catch (error) {
                alert('Erro ao deletar gasto: ' + error);
            }
        }
    </script>
}
